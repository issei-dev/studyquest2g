<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹‰å¼·RPGï¼šãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'rpg-bg': '#1f2937', // Gray-800
                        'rpg-card': '#374151', // Gray-700
                        'rpg-border': '#4b5563', // Gray-600
                        'hp-red': '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            background-color: #111827; /* Gray-900 */
            color: #f3f4f6; /* Gray-100 */
        }
        .rpg-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 0 0 #2c3e50; /* Flat shadow for RPG feel */
        }
        .rpg-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #2c3e50;
        }
        .tab-content {
            min-height: 75vh;
        }
        .rarity-n { background-color: #6b7280; } /* Normal */
        .rarity-r { background-color: #3b82f6; } /* Rare (Blue) */
        .rarity-sr { background-color: #a855f7; } /* Super Rare (Purple) */
        .rarity-ur { background-color: #f59e0b; } /* Ultra Rare (Gold) */
        .rarity-l { background-color: #ef4444; } /* Legendary (Red) */
    </style>
</head>
<body class="font-sans">

    <!-- Toast Notification Area -->
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 space-y-2"></div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-center text-secondary mb-6">ğŸ“š å‹‰å¼·RPG (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ç‰ˆ) âš”ï¸</h1>
        
        <!-- Info Banner for Local Storage -->
        <div class="bg-yellow-800 p-3 rounded-lg shadow-lg mb-6 text-sm text-yellow-100">
            <p class="font-semibold">âš ï¸ æ³¨æ„: ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
            <p class="mt-1">ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã‚‹ãŸã‚ã”æ³¨æ„ãã ã•ã„ã€‚</p>
        </div>

        <!-- User Info Bar -->
        <div id="user-info-bar" class="bg-rpg-card p-3 rounded-lg shadow-lg mb-6 flex justify-between items-center text-sm md:text-base">
            <p class="font-semibold">ãƒ¦ãƒ¼ã‚¶ãƒ¼: <span id="user-id-display" class="text-primary truncate ml-2">ãã¿</span></p>
            <p class="font-semibold">ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="stage-display" class="text-secondary ml-2">1</span></p>
            <p class="font-semibold">ã‚¬ãƒãƒ£åˆ¸: <span id="gacha-tickets-display" class="text-yellow-400 ml-2">0</span>æš</p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex space-x-1 bg-rpg-card p-1 rounded-lg shadow-inner mb-6">
            <button onclick="showTab('study')" id="tab-study" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors bg-primary hover:bg-indigo-700">å‹‰å¼·/ã‚¬ãƒãƒ£</button>
            <button onclick="showTab('inventory')" id="tab-inventory" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">ã‚¢ã‚¤ãƒ†ãƒ </button>
            <button onclick="showTab('combat')" id="tab-combat" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">æˆ¦é—˜</button>
            <button onclick="showTab('record')" id="tab-record" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">è¨˜éŒ²</button>
        </div>

        <!-- Tab Contents -->
        <div id="tab-study-content" class="tab-content bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-inventory-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-combat-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-record-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
    </div>


    <!-- JS Logic -->
    <script type="text/javascript">
        // --------------------------------------------------------------------------------
        // ** ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ (localStorage) ã‚’ä½¿ç”¨ã—ã¾ã™ **
        // --------------------------------------------------------------------------------

        let gameState = {};
        const LOCAL_STORAGE_KEY = 'studyRpgGameState';

        const rarityWeights = {
            'L': 1, // Legendary (1%)
            'UR': 4, // Ultra Rare (4%)
            'SR': 15, // Super Rare (15%)
            'R': 30, // Rare (30%)
            'N': 50, // Normal (50%)
        };

        const ITEMS = {
            weapon: [
                { id: 'w1', name: 'æœ¨ã®å‰£', rarity: 'N', atk: 5, def: 0 },
                { id: 'w2', name: 'é‰„ã®å‰£', rarity: 'R', atk: 15, def: 0 },
                { id: 'w3', name: 'é‹¼ã®å‰£', rarity: 'SR', atk: 30, def: 0 },
                { id: 'w4', name: 'ãƒŸã‚¹ãƒªãƒ«ã‚½ãƒ¼ãƒ‰', rarity: 'UR', atk: 60, def: 5 },
                { id: 'w5', name: 'è–å‰£ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼', rarity: 'L', atk: 120, def: 10 },
            ],
            armor: [
                { id: 'a1', name: 'å¸ƒã®æœ', rarity: 'N', atk: 0, def: 3 },
                { id: 'a2', name: 'é©é§', rarity: 'R', atk: 0, def: 10 },
                { id: 'a3', name: 'é–å¸·å­', rarity: 'SR', atk: 5, def: 25 },
                { id: 'a4', name: 'ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¢ãƒ¼ãƒãƒ¼', rarity: 'UR', atk: 10, def: 50 },
                { id: 'a5', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ¡ã‚¤ãƒ«', rarity: 'L', atk: 20, def: 100 },
            ],
            pet: [
                { id: 'p1', name: 'ã‚¹ãƒ©ã‚¤ãƒ ', rarity: 'N', atk: 2, def: 2, hp: 5 },
                { id: 'p2', name: 'å¦–ç²¾ãƒ”ã‚¯ã‚·ãƒ¼', rarity: 'R', atk: 5, def: 5, hp: 10 },
                { id: 'p3', name: 'å®ˆè­·çŠ¬ã‚±ãƒ«ãƒ™ãƒ­ã‚¹', rarity: 'SR', atk: 10, def: 15, hp: 20 },
                { id: 'p4', name: 'è³¢è€…ã®ãƒ•ã‚¯ãƒ­ã‚¦', rarity: 'UR', atk: 20, def: 10, hp: 40 },
                { id: 'p5', name: 'ç¥ç«œãƒ•ã‚¡ãƒ•ãƒ‹ãƒ¼ãƒ«', rarity: 'L', atk: 50, def: 30, hp: 80 },
            ]
        };

        const MONSTERS_BY_STAGE = [
            // Stage 1
            [
                { name: 'é›‘é­šã‚¹ãƒ©ã‚¤ãƒ ', hp: 20, atk: 5, def: 0, exp: 5, itemDrop: 1 },
                { name: 'ã‚´ãƒ–ãƒªãƒ³', hp: 30, atk: 8, def: 2, exp: 10, itemDrop: 2 },
            ],
            // Stage 2
            [
                { name: 'ã‚¦ã‚©ãƒ¼ã‚¦ãƒ«ãƒ•', hp: 50, atk: 15, def: 5, exp: 15, itemDrop: 3 },
                { name: 'ã‚ªãƒ¼ã‚¯', hp: 70, atk: 20, def: 8, exp: 20, itemDrop: 4 },
            ],
            // Boss for Stage 1 (Appears after 10 kills)
            { name: 'ã‚¹ãƒ†ãƒ¼ã‚¸1ãƒœã‚¹ï¼šå¤§é¬¼', hp: 200, atk: 30, def: 10, exp: 100, itemDrop: 10 },
            // Boss for Stage 2
            { name: 'ã‚¹ãƒ†ãƒ¼ã‚¸2ãƒœã‚¹ï¼šãƒªã‚¶ãƒ¼ãƒ‰ãƒãƒ³ãƒ­ãƒ¼ãƒ‰', hp: 400, atk: 50, def: 20, exp: 200, itemDrop: 20 },
        ];

        const INITIAL_STATE = {
            gachaTickets: 0,
            enhancementItems: 0, 
            stage: 1,
            maxHp: 100,
            currentHp: 100,
            baseAttack: 10,
            baseDefense: 5,
            killsUntilBoss: 10,
            inventory: [], // [{ id: 'w1', type: 'weapon', plus: 0, itemId: 'unique_id' }]
            equipment: {
                weapon1: null,
                weapon2: null,
                armor: null,
                pet1: null,
                pet2: null,
                pet3: null,
            },
            currentMonsters: [], // { name, hp, maxHp }
            lastLoginDate: new Date().toDateString(),
            studyLogs: [], // [{ timestamp: number, stampType: string }]
        };

        // --- Local Storage Management ---

        function loadGameState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
                try {
                    // æ—¢å­˜ã® gameState ã¨çµåˆã—ã¦ã€æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚‚å¯¾å¿œ
                    const parsedState = JSON.parse(savedState);
                    gameState = { ...INITIAL_STATE, ...parsedState };
                } catch (e) {
                    console.error("Failed to parse game state from localStorage. Using initial state.", e);
                    gameState = INITIAL_STATE;
                }
            } else {
                gameState = INITIAL_STATE;
            }
        }

        function saveGameState() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Failed to save game state to localStorage.", e);
                showToast("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", 'error');
            }
        }

        // --- Core Application Setup ---
        window.onload = function() {
            // 1. Load State
            loadGameState();

            // 2. Initial Setup
            setupApp();
        };

        function setupApp() {
            // ãƒ­ã‚°ã‚¤ãƒ³æ—¥ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€HPã‚’å›å¾©
            checkAndResetHP(); 
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
            calculateStats();
            // UIã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderUI();
            
            showTab('study');
        }

        // --- State Management and Calculations ---

        function calculateStats() {
            const equipped = gameState.equipment;
            let totalAtk = gameState.baseAttack;
            let totalDef = gameState.baseDefense;
            let totalMaxHp = gameState.maxHp;

            const equipSlots = ['weapon1', 'weapon2', 'armor', 'pet1', 'pet2', 'pet3'];

            equipSlots.forEach(slot => {
                const itemId = equipped[slot];
                if (!itemId) return;

                const itemEntry = gameState.inventory.find(inv => inv.itemId === itemId);
                
                if (itemEntry && itemEntry.type && ITEMS[itemEntry.type] && Array.isArray(ITEMS[itemEntry.type])) {
                    const itemData = ITEMS[itemEntry.type].find(i => i.id === itemEntry.id);
                    if (itemData) {
                        const plus = itemEntry.plus || 0;
                        totalAtk += (itemData.atk || 0) + plus;
                        totalDef += (itemData.def || 0) + plus;
                        totalMaxHp += (itemData.hp || 0) + (plus * 2);
                    }
                }
            });

            // Update stats in gameState
            gameState.totalAttack = totalAtk;
            gameState.totalDefense = totalDef;
            gameState.totalMaxHp = totalMaxHp;

            // UI update
            document.getElementById('stage-display').textContent = gameState.stage;
            document.getElementById('gacha-tickets-display').textContent = gameState.gachaTickets;
        }

        function updateGameState(updates) {
            // Local state update
            Object.assign(gameState, updates);
            
            // Re-calculate stats and save state immediately
            calculateStats();
            saveGameState();
            renderUI();
        }

        function checkAndResetHP() {
            const today = new Date().toDateString();
            if (gameState.lastLoginDate !== today) {
                // maxHpã‚’è¨ˆç®—ã—ã¦ã‹ã‚‰å›å¾©
                calculateStats();
                gameState.currentHp = gameState.totalMaxHp;
                gameState.lastLoginDate = today;
                updateGameState({ currentHp: gameState.currentHp, lastLoginDate: today });
                showToast("ä½“åŠ›å…¨å›å¾©ï¼æ–°ã—ã„ä¸€æ—¥ãŒå§‹ã¾ã£ãŸã‚ˆï¼", 'info');
            } else if (gameState.currentHp > (gameState.totalMaxHp || INITIAL_STATE.maxHp)) {
                 // Adjust HP down if max HP reduced
                gameState.currentHp = gameState.totalMaxHp;
                updateGameState({ currentHp: gameState.currentHp });
            } else if (gameState.currentHp <= 0 && document.getElementById('tab-combat-content').style.display !== 'none') {
                showToast("æˆ¦é—˜ä¸èƒ½ï¼æ˜æ—¥ã®å›å¾©ã‚’å¾…ã¨ã†ã€‚", 'error');
            }
        }

        // --- UI Rendering ---

        window.showTab = function(tabName) {
            ['study', 'inventory', 'combat', 'record'].forEach(name => {
                const content = document.getElementById(`tab-${name}-content`);
                const tab = document.getElementById(`tab-${name}`);
                if (content && tab) {
                    content.classList.toggle('hidden', name !== tabName);
                    tab.classList.toggle('bg-primary', name === tabName);
                    tab.classList.toggle('hover:bg-indigo-700', name === tabName);
                    tab.classList.toggle('hover:bg-rpg-border', name !== tabName);
                    tab.classList.toggle('bg-rpg-border', name !== tabName);
                    tab.classList.toggle('text-white', name === tabName);
                }
            });

            // Specific content rendering based on tab
            switch (tabName) {
                case 'study':
                    renderStudyTab();
                    break;
                case 'inventory':
                    renderInventoryTab();
                    break;
                case 'combat':
                    renderCombatTab();
                    break;
                case 'record':
                    renderRecordTab();
                    break;
            }
        };

        function renderUI() {
            calculateStats();
            const currentTabElement = document.querySelector('.tab-content:not(.hidden)');
            const currentTab = currentTabElement ? currentTabElement.id.replace('tab-', '').replace('-content', '') : 'study';
            showTab(currentTab); // Re-render current tab
        }

        // --- Helper Functions ---

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-secondary';
            if (type === 'error') bgColor = 'bg-hp-red';
            if (type === 'info') bgColor = 'bg-blue-500';

            toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 transform translate-y-2`;
            toast.textContent = message;
            container.appendChild(toast);

            // Fade in and move up
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 50);

            // Fade out and remove
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function getRarityClass(rarity) {
            return `rarity-${rarity.toLowerCase()} text-white font-bold px-2 py-0.5 rounded-full text-xs`;
        }

        function getItemDetails(itemId, type) {
            const itemArray = ITEMS[type];
            if (!itemArray || !Array.isArray(itemArray)) {
                return { name: 'ä¸æ˜ãªã‚¢ã‚¤ãƒ†ãƒ ', rarity: 'N', atk: 0, def: 0, hp: 0 };
            }
            const item = itemArray.find(i => i.id === itemId);
            return item || { name: 'ä¸æ˜ãªã‚¢ã‚¤ãƒ†ãƒ ', rarity: 'N', atk: 0, def: 0, hp: 0 };
        }

        // --- TAB 1: Study & Gacha ---

        window.stampStudy = function(type) {
            const typeNames = {
                'math': 'æ•°å­¦', 'code': 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'lang': 'èªå­¦', 'other': 'ãã®ä»–'
            };

            // Add log (timestamp in milliseconds for local storage)
            const newLog = {
                timestamp: Date.now(),
                stampType: typeNames[type],
            };
            
            // Study logs are stored as an array in gameState
            const newStudyLogs = [...(gameState.studyLogs || []), newLog];

            // Update State (including gacha ticket grant)
            updateGameState({
                gachaTickets: gameState.gachaTickets + 1,
                studyLogs: newStudyLogs,
            });
            
            showToast(`ãã‚‡ã†ã‚‚ãŒã‚“ã°ã£ãŸã­ï¼ (${typeNames[type]}) ã‚¬ãƒãƒ£åˆ¸+1`, 'success');
        };

        function renderStudyTab() {
            const content = document.getElementById('tab-study-content');
            
            // Study Stamp Section
            const stampHtml = `
                <div class="mb-8 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">å‹‰å¼·ã‚¹ã‚¿ãƒ³ãƒ—æ©Ÿèƒ½</h2>
                    <p class="mb-4 text-sm text-gray-400">å‹‰å¼·å†…å®¹ã«åˆã‚ã›ã¦ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã™ã¨ã€ã‚¬ãƒãƒ£åˆ¸ãŒã‚‚ã‚‰ãˆã¾ã™ã€‚</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="stampStudy('math')" class="rpg-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-lg">
                            ğŸ”¢ æ•°å­¦
                        </button>
                        <button onclick="stampStudy('code')" class="rpg-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl text-lg">
                            ğŸ’» ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°
                        </button>
                        <button onclick="stampStudy('lang')" class="rpg-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded-xl text-lg">
                            ğŸ—£ï¸ èªå­¦
                        </button>
                        <button onclick="stampStudy('other')" class="rpg-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl text-lg">
                            â­ ãã®ä»–
                        </button>
                    </div>
                </div>
            `;

            // Gacha Section
            const gachaHtml = `
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ã‚¬ãƒãƒ£æ©Ÿèƒ½</h2>
                    <p class="mb-4 text-sm text-gray-400">ç¾åœ¨ã€ã‚¬ãƒãƒ£åˆ¸: <span class="text-yellow-400 font-bold">${gameState.gachaTickets}</span>æš</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="pullGacha('weapon')" ${gameState.gachaTickets > 0 ? '' : 'disabled'}
                                class="rpg-button ${gameState.gachaTickets > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-500 cursor-not-allowed'} text-white font-bold py-4 rounded-xl text-xl">
                            âš”ï¸ æ­¦å™¨ã‚¬ãƒãƒ£ (1æšæ¶ˆè²»)
                        </button>
                        <button onclick="pullGacha('pet')" ${gameState.gachaTickets > 0 ? '' : 'disabled'}
                                class="rpg-button ${gameState.gachaTickets > 0 ? 'bg-teal-600 hover:bg-teal-700' : 'bg-gray-500 cursor-not-allowed'} text-white font-bold py-4 rounded-xl text-xl">
                            ğŸ¾ ãƒšãƒƒãƒˆã‚¬ãƒãƒ£ (1æšæ¶ˆè²»)
                        </button>
                    </div>
                    <p class="mt-4 text-xs text-gray-400">
                        ç¢ºç‡: N(50%), R(30%), SR(15%), UR(4%), L(1%)<br>
                        åŒä¸€ã‚¢ã‚¤ãƒ†ãƒ ã¯+1ã•ã‚Œã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¼·åŒ–ã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>
            `;
            content.innerHTML = stampHtml + gachaHtml;
        }

        window.pullGacha = function(type) {
            if (gameState.gachaTickets <= 0) {
                showToast("ã‚¬ãƒãƒ£åˆ¸ãŒè¶³ã‚Šã¾ã›ã‚“ï¼", 'error');
                return;
            }

            // 1. Determine Rarity
            const rand = Math.random() * 100;
            let cumulativeWeight = 0;
            let selectedRarity = null;
            const rarities = Object.keys(rarityWeights).reverse(); // L, UR, SR, R, N

            for (const rarity of rarities) {
                cumulativeWeight += rarityWeights[rarity];
                if (rand < cumulativeWeight) {
                    selectedRarity = rarity;
                    break;
                }
            }
            if (!selectedRarity) selectedRarity = 'N';

            // 2. Select Item of that Rarity
            const availableItems = ITEMS[type].filter(item => item.rarity === selectedRarity);
            const selectedItemData = availableItems[Math.floor(Math.random() * availableItems.length)];
            
            // 3. Check Inventory for Duplicates
            const existingItemIndex = gameState.inventory.findIndex(inv => inv.id === selectedItemData.id);

            if (existingItemIndex !== -1) {
                // Duplicate: Increase plus value
                gameState.inventory[existingItemIndex].plus = (gameState.inventory[existingItemIndex].plus || 0) + 1;
                showToast(`[+${gameState.inventory[existingItemIndex].plus}] ${selectedItemData.name} ã‚’å…¥æ‰‹ï¼å¼·åŒ–ã•ã‚Œã¾ã—ãŸï¼`, selectedRarity === 'L' ? 'info' : 'success');
            } else {
                // New Item: Add to inventory
                const newItem = {
                    id: selectedItemData.id,
                    type: type,
                    plus: 0,
                    itemId: crypto.randomUUID(), // Unique ID for equipping
                };
                gameState.inventory.push(newItem);
                showToast(`[${selectedRarity}] ${selectedItemData.name} ã‚’æ–°ã—ãå…¥æ‰‹ï¼`, selectedRarity === 'L' ? 'info' : 'success');
            }

            // 4. Update Game State
            updateGameState({
                gachaTickets: gameState.gachaTickets - 1,
                inventory: gameState.inventory
            });
        };

        // --- TAB 2: Inventory & Equipment ---

        function renderInventoryTab() {
            calculateStats();
            const content = document.getElementById('tab-inventory-content');

            // --- A. Stat Display ---
            const statHtml = `
                <div class="mb-6 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ä¸»äººå…¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                    <div class="flex flex-wrap gap-4 text-lg">
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-hp-red">HP:</span> ${gameState.currentHp} / ${gameState.totalMaxHp}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-red-400">ATK (æ”»æ’ƒåŠ›):</span> ${gameState.totalAttack}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-blue-400">DEF (é˜²å¾¡åŠ›):</span> ${gameState.totalDefense}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-yellow-400">å¼·åŒ–ã‚¢ã‚¤ãƒ†ãƒ :</span> ${gameState.enhancementItems}å€‹</div>
                    </div>
                </div>
            `;

            // --- B. Equipment Slots ---
            const slots = {
                weapon1: { label: 'æ­¦å™¨1', icon: 'âš”ï¸' },
                weapon2: { label: 'æ­¦å™¨2', icon: 'ğŸ—¡ï¸' },
                armor: { label: 'é˜²å…·', icon: 'ğŸ›¡ï¸' },
                pet1: { label: 'ãƒšãƒƒãƒˆ1', icon: 'ğŸ¾' },
                pet2: { label: 'ãƒšãƒƒãƒˆ2', icon: 'ğŸ¾' },
                pet3: { label: 'ãƒšãƒƒãƒˆ3', icon: 'ğŸ¾' },
            };

            const equipHtml = `
                <div class="mb-8 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">è£…å‚™ (2æ­¦å™¨ / 1é˜²å…· / 3ãƒšãƒƒãƒˆ)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${Object.entries(slots).map(([slotKey, slotInfo]) => {
                            const equippedItemId = gameState.equipment[slotKey];
                            const equippedItemEntry = gameState.inventory.find(inv => inv.itemId === equippedItemId);
                            
                            let itemDisplay = '<span class="text-gray-400">æœªè£…å‚™</span>';
                            let itemClass = 'bg-gray-700';
                            if (equippedItemEntry) {
                                const itemData = getItemDetails(equippedItemEntry.id, equippedItemEntry.type);
                                itemDisplay = `${itemData.name} +${equippedItemEntry.plus}`;
                                itemClass = `bg-primary`;
                            }

                            return `
                                <div class="p-3 rounded-lg ${itemClass} shadow-md flex justify-between items-center text-sm md:text-base">
                                    <span class="font-bold">${slotInfo.icon} ${slotInfo.label}:</span>
                                    <span class="truncate ml-2">${itemDisplay}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // --- C. Inventory List ---
            const inventoryHtml = `
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ã‚¢ã‚¤ãƒ†ãƒ ä¸€è¦§ (${gameState.inventory.length}ç¨®é¡)</h2>
                    <div class="space-y-3">
                        ${gameState.inventory.length === 0 ? '<p class="text-center text-gray-400">ã‚¬ãƒãƒ£ã‚’å¼•ã„ã¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹ã—ã‚ˆã†ï¼</p>' : ''}
                        ${gameState.inventory.map(itemEntry => {
                            const itemData = getItemDetails(itemEntry.id, itemEntry.type);
                            const isEquipped = Object.values(gameState.equipment).includes(itemEntry.itemId);
                            const statText = itemEntry.type === 'pet'
                                ? `HP+${itemData.hp}, ATK+${itemData.atk}, DEF+${itemData.def}`
                                : `ATK+${itemData.atk}, DEF+${itemData.def}`;
                            const typeLabel = itemEntry.type === 'weapon' ? 'æ­¦å™¨' : (itemEntry.type === 'armor' ? 'é˜²å…·' : 'ãƒšãƒƒãƒˆ');
                            const canEnhance = gameState.enhancementItems > 0 && itemEntry.plus < 100; // Limit enhancement for sanity

                            return `
                                <div class="bg-rpg-border p-3 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg">
                                    <div class="flex items-center mb-2 md:mb-0 w-full md:w-3/5">
                                        <span class="${getRarityClass(itemData.rarity)} mr-2">${itemData.rarity}</span>
                                        <span class="font-extrabold text-lg mr-2">${itemData.name}</span>
                                        <span class="text-yellow-400 font-bold text-xl">+${itemEntry.plus}</span>
                                        <span class="ml-4 text-xs bg-gray-600 px-2 py-0.5 rounded">${typeLabel}</span>
                                        ${isEquipped ? '<span class="ml-2 text-sm bg-green-500 px-2 py-0.5 rounded text-white font-bold">è£…å‚™ä¸­</span>' : ''}
                                    </div>
                                    <div class="flex flex-wrap gap-2 w-full md:w-2/5 justify-start md:justify-end">
                                        <span class="text-sm text-gray-300 mr-4">${statText}</span>
                                        <button onclick="enhanceItem('${itemEntry.itemId}')" ${canEnhance ? '' : 'disabled'}
                                            class="rpg-button ${canEnhance ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-500 cursor-not-allowed'} text-white text-xs px-2 py-1 rounded">
                                            å¼·åŒ– (+1)
                                        </button>
                                        <button onclick="toggleEquip('${itemEntry.itemId}')"
                                            class="rpg-button ${isEquipped ? 'bg-red-500 hover:bg-red-600' : 'bg-secondary hover:bg-emerald-600'} text-white text-xs px-2 py-1 rounded">
                                            ${isEquipped ? 'è§£é™¤' : 'è£…å‚™'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            content.innerHTML = statHtml + equipHtml + inventoryHtml;
        }

        window.enhanceItem = function(itemId) {
            if (gameState.enhancementItems <= 0) {
                showToast("å¼·åŒ–ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", 'error');
                return;
            }

            const itemIndex = gameState.inventory.findIndex(inv => inv.itemId === itemId);
            if (itemIndex === -1) return;

            gameState.inventory[itemIndex].plus = (gameState.inventory[itemIndex].plus || 0) + 1;
            
            updateGameState({
                inventory: gameState.inventory,
                enhancementItems: gameState.enhancementItems - 1,
            });

            const itemData = getItemDetails(gameState.inventory[itemIndex].id, gameState.inventory[itemIndex].type);
            showToast(`${itemData.name}ãŒ+${gameState.inventory[itemIndex].plus}ã«å¼·åŒ–ã•ã‚Œã¾ã—ãŸï¼`, 'success');
        };

        window.toggleEquip = function(itemId) {
            const itemEntry = gameState.inventory.find(inv => inv.itemId === itemId);
            if (!itemEntry) return;
            const type = itemEntry.type;
            
            let updates = {};
            let action = 'equip';

            let slotToUnequip = null;
            let slotToEquip = null;

            // Find where it's equipped
            for (const [key, value] of Object.entries(gameState.equipment)) {
                if (value === itemId) {
                    slotToUnequip = key;
                    action = 'unequip';
                    break;
                }
            }

            if (action === 'unequip') {
                // Unequip action
                updates.equipment = { ...gameState.equipment, [slotToUnequip]: null };
            } else {
                // Equip action
                const slotsForType = {
                    weapon: ['weapon1', 'weapon2'],
                    armor: ['armor'],
                    pet: ['pet1', 'pet2', 'pet3']
                }[type];

                // Find the first empty slot or the first occupied slot of the same type to overwrite
                slotToEquip = slotsForType.find(slot => !gameState.equipment[slot]);
                if (!slotToEquip) {
                    // If all slots of this type are full, overwrite the first one (simple logic)
                    slotToEquip = slotsForType[0];
                }
                updates.equipment = { ...gameState.equipment, [slotToEquip]: itemId };
            }

            updateGameState(updates);
            showToast(action === 'equip' ? `${itemEntry.name}ã‚’è£…å‚™ã—ã¾ã—ãŸã€‚` : `${itemEntry.name}ã®è£…å‚™ã‚’è§£é™¤ã—ã¾ã—ãŸã€‚`, 'info');
        };

        // --- TAB 3: Combat ---

        function renderCombatTab() {
            calculateStats();
            const content = document.getElementById('tab-combat-content');
            
            if (gameState.currentHp <= 0) {
                content.innerHTML = `
                    <div class="text-center p-8 bg-hp-red rounded-xl shadow-2xl">
                        <h2 class="text-3xl font-bold mb-4">ğŸ’€ æˆ¦é—˜ä¸èƒ½ ğŸ’€</h2>
                        <p class="text-xl">ãã¿ã®HPã¯0ã ï¼ä»Šæ—¥ã¯ã‚‚ã†ä¼‘ã‚‚ã†ã€‚</p>
                        <p class="mt-4">ä½“åŠ›ã¯æ—¥ä»˜ãŒå¤‰ã‚ã‚‹ã¨å…¨å›å¾©ã—ã¾ã™ã€‚</p>
                    </div>
                `;
                return;
            }

            // If no monsters, initialize them
            if (gameState.currentMonsters.length === 0) {
                initializeMonsters();
            }

            // Stat Display (detailed)
            const statHtml = `
                <div class="mb-6 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-3 text-primary">ä¸»äººå…¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
                    <div class="bg-gray-600 p-3 rounded-lg shadow-inner">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">HP:</span>
                            <span class="font-mono text-hp-red">${gameState.currentHp} / ${gameState.totalMaxHp}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="bg-hp-red h-3 rounded-full" style="width: ${Math.max(0, (gameState.currentHp / gameState.totalMaxHp) * 100)}%"></div>
                        </div>
                        <div class="flex justify-around mt-2 text-sm">
                            <p>ATK: <span class="text-red-400 font-bold">${gameState.totalAttack}</span></p>
                            <p>DEF: <span class="text-blue-400 font-bold">${gameState.totalDefense}</span></p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">æ¬¡ã®ãƒœã‚¹ã¾ã§ã‚ã¨ ${gameState.killsUntilBoss} åŒ¹</p>
                </div>
            `;

            // Monster Display
            const monsterHtml = `
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ã‚¹ãƒ†ãƒ¼ã‚¸ ${gameState.stage} ã®æ•µ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${gameState.currentMonsters.map((m, index) => {
                            const hpPercent = Math.max(0, (m.hp / m.maxHp) * 100);
                            return `
                                <div id="monster-${index}" class="bg-rpg-border p-3 rounded-lg shadow-lg ${m.hp <= 0 ? 'opacity-50' : ''}">
                                    <p class="font-bold text-lg">${m.name} ${m.hp <= 0 ? '(æ’ƒç ´)' : ''}</p>
                                    <p class="text-sm">HP: <span class="font-mono">${Math.max(0, m.hp)} / ${m.maxHp}</span></p>
                                    <div class="w-full bg-gray-700 rounded-full h-2 my-1">
                                        <div class="bg-yellow-400 h-2 rounded-full" style="width: ${hpPercent}%"></div>
                                    </div>
                                    <p class="text-xs">ATK:${m.atk} / DEF:${m.def}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // Action Button
            const actionHtml = `
                <div class="text-center">
                    <button onclick="playerAttack()" class="rpg-button bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-8 rounded-xl text-xl">
                        ğŸ”¥ æ”»æ’ƒã™ã‚‹
                    </button>
                    <div id="combat-log" class="mt-4 p-3 bg-gray-700 rounded-lg max-h-40 overflow-y-auto text-left text-sm space-y-1">
                        <p class="text-gray-400">æˆ¦é—˜ãƒ­ã‚°</p>
                    </div>
                </div>
            `;

            content.innerHTML = statHtml + monsterHtml + actionHtml;
        }

        function initializeMonsters() {
            const monsters = [];
            const stageMonsters = MONSTERS_BY_STAGE[gameState.stage - 1];
            
            // Check for Boss Condition
            if (gameState.killsUntilBoss <= 0) {
                // Boss
                // MONSTERS_BY_STAGEã®æ§‹é€ ä¸Šã€ãƒœã‚¹ãƒ‡ãƒ¼ã‚¿ã¯æœ«å°¾ã‹ã‚‰2ã¤ç›®/1ã¤ç›®ã«ã‚ã‚‹
                const bossDataIndex = gameState.stage === 1 ? MONSTERS_BY_STAGE.length - 2 : MONSTERS_BY_STAGE.length - 1;
                const bossData = MONSTERS_BY_STAGE[bossDataIndex];
                monsters.push({ ...bossData, hp: bossData.hp, maxHp: bossData.hp });
            } else {
                // 3 regular monsters
                for (let i = 0; i < 3; i++) {
                    const monsterData = stageMonsters[Math.floor(Math.random() * stageMonsters.length)];
                    monsters.push({ ...monsterData, hp: monsterData.hp, maxHp: monsterData.hp });
                }
            }

            gameState.currentMonsters = monsters;
            updateGameState({ currentMonsters: monsters });
        }

        function appendLog(message, isPlayer = false) {
            const logElement = document.getElementById('combat-log');
            if (!logElement) return;

            const entry = document.createElement('p');
            entry.className = isPlayer ? 'text-green-300' : 'text-yellow-300';
            entry.textContent = message;

            logElement.prepend(entry);
            // Keep max 10 entries
            while (logElement.children.length > 10) {
                logElement.removeChild(logElement.lastChild);
            }
        }

        window.playerAttack = function() {
            if (gameState.currentHp <= 0) {
                showToast("æˆ¦é—˜ä¸èƒ½ã§ã™ã€‚", 'error');
                return;
            }

            const activeMonsters = gameState.currentMonsters.filter(m => m.hp > 0);
            if (activeMonsters.length === 0) {
                checkStageCompletion();
                return;
            }

            // 1. Player Attack Phase (Target the first alive monster)
            const targetIndex = gameState.currentMonsters.findIndex(m => m.hp > 0);
            if (targetIndex === -1) return;

            const targetMonster = gameState.currentMonsters[targetIndex];
            const playerDmg = Math.max(1, gameState.totalAttack - targetMonster.def);
            targetMonster.hp -= playerDmg;

            appendLog(`ä¸»äººå…¬ã®æ”»æ’ƒï¼ ${targetMonster.name}ã« ${playerDmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, true);

            let monsterDefeated = false;
            // Check if monster is defeated
            if (targetMonster.hp <= 0) {
                targetMonster.hp = 0;
                appendLog(`ğŸ‰ ${targetMonster.name} ã‚’æ’ƒç ´ã—ãŸï¼`, true);
                monsterDefeated = true;
                
                // Drop items and check boss progress
                gameState.enhancementItems += targetMonster.itemDrop;
                appendLog(`+${targetMonster.itemDrop} å¼·åŒ–ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹ï¼`, true);

                if (gameState.killsUntilBoss > 0) {
                    gameState.killsUntilBoss--;
                }
            }
            
            // Check for immediate completion (e.g. one-shotting the last monster)
            if (gameState.currentMonsters.filter(m => m.hp > 0).length === 0) {
                updateGameState({
                    currentMonsters: gameState.currentMonsters,
                    enhancementItems: gameState.enhancementItems,
                    killsUntilBoss: gameState.killsUntilBoss,
                });
                checkStageCompletion();
                return; 
            }

            // 2. Monster Attack Phase (All alive monsters attack sequentially)
            let playerFainted = false;
            for (let i = 0; i < gameState.currentMonsters.length; i++) {
                const monster = gameState.currentMonsters[i];
                if (monster.hp > 0) {
                    const monsterDmg = Math.max(1, monster.atk - gameState.totalDefense);
                    gameState.currentHp -= monsterDmg;

                    appendLog(`${monster.name} ã®æ”»æ’ƒï¼ ${monsterDmg} ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼`);

                    if (gameState.currentHp <= 0) {
                        gameState.currentHp = 0;
                        appendLog(`ğŸ’€ ä¸»äººå…¬ã¯æˆ¦é—˜ä¸èƒ½ã«ãªã£ãŸ...`, false);
                        playerFainted = true;
                        break;
                    }
                }
            }

            // 3. Update State and UI
            updateGameState({
                currentHp: gameState.currentHp,
                currentMonsters: gameState.currentMonsters,
                enhancementItems: gameState.enhancementItems,
                killsUntilBoss: gameState.killsUntilBoss,
            });

            if (!playerFainted && monsterDefeated) {
                // If a monster was defeated but others are still alive, check stage completion for boss spawn
                checkStageCompletion(); 
            }
        };

        function checkStageCompletion() {
            const allMonstersDefeated = gameState.currentMonsters.filter(m => m.hp > 0).length === 0;
            
            if (!allMonstersDefeated) return;

            // Check if the defeated monster was a boss
            const isBoss = gameState.currentMonsters.some(m => m.name.includes('ãƒœã‚¹'));

            if (isBoss) {
                // Boss defeated: Advance Stage
                const nextStage = gameState.stage + 1;
                if (nextStage <= MONSTERS_BY_STAGE.length - 2) { // Max stage check
                    showToast(`ğŸ† ã‚¹ãƒ†ãƒ¼ã‚¸${gameState.stage}ã‚’ã‚¯ãƒªã‚¢ï¼æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ï¼`, 'info');
                    updateGameState({
                        stage: nextStage,
                        killsUntilBoss: 10,
                        currentMonsters: [],
                    });
                } else {
                    showToast("ğŸ‰ å…¨ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ï¼å›ã¯æœ€å¼·ã ï¼", 'info');
                    updateGameState({ currentMonsters: [] });
                }
            } else if (gameState.killsUntilBoss <= 0) {
                // Regular monsters defeated, and boss threshold reached: Spawn Boss
                showToast("ğŸš¨ å¼·åŠ›ãªé­”åŠ›ã®æ°—é…...ã‚¹ãƒ†ãƒ¼ã‚¸ãƒœã‚¹ãŒå‡ºç¾ã—ãŸï¼", 'error');
                updateGameState({ currentMonsters: [] }); // Clear and re-init will spawn boss
            } else {
                // Regular monsters defeated, reset 3 new ones
                showToast("æ•µã‚’å…¨ã¦å€’ã—ãŸï¼æ–°ãŸãªæ•µãŒç¾ã‚ŒãŸã€‚", 'success');
                updateGameState({ currentMonsters: [] });
            }
            
            // Re-render to initialize new monsters/stage
            renderCombatTab();
        }

        // --- TAB 4: Record ---

        function renderRecordTab() {
            const content = document.getElementById('tab-record-content');
            // Log array is sorted in place for rendering purposes (latest first)
            const logs = [...(gameState.studyLogs || [])].sort((a, b) => b.timestamp - a.timestamp);

            const recordHtml = `
                <h2 class="text-2xl font-semibold mb-4 text-primary">å‹‰å¼·è¨˜éŒ²ãƒšãƒ¼ã‚¸</h2>
                <div class="space-y-3 max-h-96 overflow-y-auto p-2">
                    ${logs.length === 0 
                        ? '<p class="text-center text-gray-400">ã¾ã å‹‰å¼·è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æŠ¼ã—ã¦è¨˜éŒ²ã—ã¾ã—ã‚‡ã†ï¼</p>' 
                        : logs.map(log => {
                            const date = new Date(log.timestamp).toLocaleString('ja-JP', { dateStyle: 'medium', timeStyle: 'short' });
                            const bgColor = {
                                'æ•°å­¦': 'bg-blue-600', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°': 'bg-green-600', 'èªå­¦': 'bg-yellow-600', 'ãã®ä»–': 'bg-purple-600'
                            }[log.stampType] || 'bg-gray-600';

                            return `
                                <div class="p-3 rounded-lg ${bgColor} bg-opacity-70 shadow-md flex justify-between items-center text-white">
                                    <span class="font-bold">${log.stampType} ã‚¹ã‚¿ãƒ³ãƒ—</span>
                                    <span class="text-sm">${date}</span>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
            content.innerHTML = recordHtml;
        }

    </script>
</body>
</html>
