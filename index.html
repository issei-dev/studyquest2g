<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勉強RPG（画像対応・アニメーション版）</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'rpg-bg': '#1f2937', // Gray-800
                        'rpg-card': '#374151', // Gray-700
                        'rpg-border': '#4b5563', // Gray-600
                        'hp-red': '#ef4444',
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* カスタムスタイル */
        body {
            background-color: #111827; /* Gray-900 */
            color: #f3f4f6; /* Gray-100 */
        }
        .rpg-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 0 0 #2c3e50; /* Flat shadow for RPG feel */
        }
        .rpg-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #2c3e50;
        }
        .tab-content {
            min-height: 75vh;
        }
        .rarity-n { background-color: #6b7280; } /* Normal */
        .rarity-r { background-color: #3b82f6; } /* Rare (Blue) */
        .rarity-sr { background-color: #a855f7; } /* Super Rare (Purple) */
        .rarity-ur { background-color: #f59e0b; } /* Ultra Rare (Gold) */
        .rarity-l { background-color: #ef4444; } /* Legendary (Red) */
        
        /* 画像表示用スタイル */
        .item-icon, .monster-icon {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 4px;
        }
        .monster-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            display: block;
        }


        /* 攻撃時の揺れアニメーション */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* モーダル背景 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="font-sans">

    <!-- Toast Notification Area -->
    <div id="toast-container" class="fixed top-5 left-1/2 transform -translate-x-1/2 z-50 space-y-2"></div>

    <!-- Modal for Gacha/Stamp Confirmation -->
    <div id="rpg-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay">
        <div class="bg-rpg-card p-6 rounded-xl shadow-2xl max-w-sm w-full border-2 border-primary transform scale-90 transition-transform duration-300" id="modal-content-container">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-primary">メッセージ</h3>
            <p id="modal-message" class="mb-6 text-gray-200"></p>
            <div class="flex justify-center">
                <button id="modal-ok-button" class="rpg-button bg-secondary hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-xl text-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-center text-secondary mb-6">📚 勉強RPG (画像対応版) ⚔️</h1>
        
        <!-- User Info Bar -->
        <div id="user-info-bar" class="bg-rpg-card p-3 rounded-lg shadow-lg mb-6 flex justify-between items-center text-sm md:text-base">
            <p class="font-semibold">ユーザー: <span id="user-id-display" class="text-primary truncate ml-2">きみ</span></p>
            <p class="font-semibold">ステージ: <span id="stage-display" class="text-secondary ml-2">1</span></p>
            <p class="font-semibold">ガチャ券: <span id="gacha-tickets-display" class="text-yellow-400 ml-2">0</span>枚</p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex space-x-1 bg-rpg-card p-1 rounded-lg shadow-inner mb-6">
            <button onclick="showTab('study')" id="tab-study" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors bg-primary hover:bg-indigo-700">勉強/ガチャ</button>
            <button onclick="showTab('inventory')" id="tab-inventory" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">アイテム</button>
            <button onclick="showTab('combat')" id="tab-combat" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">戦闘</button>
            <button onclick="showTab('record')" id="tab-record" class="flex-1 py-2 px-4 rounded-md text-center text-sm md:text-base font-medium transition-colors hover:bg-rpg-border">記録</button>
        </div>

        <!-- Tab Contents -->
        <div id="tab-study-content" class="tab-content bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-inventory-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-combat-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
        <div id="tab-record-content" class="tab-content hidden bg-rpg-card p-4 rounded-lg shadow-xl"></div>
    </div>


    <!-- JS Logic -->
    <script type="text/javascript">
        // --------------------------------------------------------------------------------
        // ** ローカル保存 (localStorage) を使用します **
        // --------------------------------------------------------------------------------

        let gameState = {};
        const LOCAL_STORAGE_KEY = 'studyRpgGameState';
        let isModalOpen = false; // モーダル開閉状態を管理するフラグ

        const rarityWeights = {
            'L': 1, 
            'UR': 4,
            'SR': 15,
            'R': 30,
            'N': 50,
        };

        // --- 画像表示のための設定 ---
        // ユーザーが画像をアップロードする際の置き換え場所として、プレースホルダーURLを使用します。
        const ITEM_BASE_URL = "https://placehold.co/50x50/374151/f3f4f6?font=inter&text=";
        const MONSTER_BASE_URL = "https://placehold.co/60x60/1f2937/ef4444?font=inter&text=";

        const ITEMS = {
            // 武器と防具に基本HP 'hp: 0' を追加 (強化ボーナスを統一するため)
            weapon: [
                // N レアリティ
                { id: 'w1', name: '木の剣', rarity: 'N', atk: 5, def: 0, hp: 0, icon: ITEM_BASE_URL + 'sq2-w1' },
                { id: 'w2', name: '木の斧', rarity: 'N', atk: 3, def: 2, hp: 0, icon: ITEM_BASE_URL + 'sq2-w2' },
                { id: 'w3', name: '木の杖', rarity: 'N', atk: 2, def: 0, hp: 3, icon: ITEM_BASE_URL + 'sq2-w3' },
                { id: 'w4', name: '木の盾', rarity: 'N', atk: 0, def: 5, hp: 0, icon: ITEM_BASE_URL + 'sq2-w4' },
                { id: 'w5', name: '石の剣', rarity: 'N', atk: 4, def: 0, hp: 1, icon: ITEM_BASE_URL + 'sq2-w5' },
                { id: 'w6', name: '石の斧', rarity: 'N', atk: 3, def: 1, hp: 1, icon: ITEM_BASE_URL + 'sq2-w6' },
                { id: 'w7', name: '石の槍', rarity: 'N', atk: 2, def: 2, hp: 1, icon: ITEM_BASE_URL + 'sq2-w7' },
                { id: 'w8', name: '石の盾', rarity: 'N', atk: 0, def: 4, hp: 1, icon: ITEM_BASE_URL + 'sq2-w8' },
                // R レアリティ
                { id: 'w9', name: '鉄の剣', rarity: 'R', atk: 15, def: 0, hp: 0, icon: ITEM_BASE_URL + 'sq2-w9' },
                { id: 'w10', name: '鉄の斧', rarity: 'R', atk: 10, def: 5, hp: 0, icon: ITEM_BASE_URL + 'sq2-w10' },
                { id: 'w11', name: '鉄の槍', rarity: 'R', atk: 10, def: 0, hp: 5, icon: ITEM_BASE_URL + 'sq2-w11' },
                { id: 'w12', name: '鉄の盾', rarity: 'R', atk: 0, def: 15, hp: 0, icon: ITEM_BASE_URL + 'sq2-w12' },
                // SR レアリティ
                { id: 'w13', name: '金の剣', rarity: 'SR', atk: 45, def: 0, hp: 0, icon: ITEM_BASE_URL + 'sq2-w13' },
                { id: 'w14', name: '金の斧', rarity: 'SR', atk: 30, def: 15, hp: 0, icon: ITEM_BASE_URL + 'sq2-w14' },
                { id: 'w15', name: '金の槍', rarity: 'SR', atk: 30, def: 0, hp: 15, icon: ITEM_BASE_URL + 'sq2-w15' },
                { id: 'w16', name: '金の盾', rarity: 'SR', atk: 0, def: 45, hp: 0, icon: ITEM_BASE_URL + 'sq2-w16' },
                // UR レアリティ
                { id: 'w17', name: 'ダイヤモンドの剣', rarity: 'UR', atk: 135, def: 0, hp: 0, icon: ITEM_BASE_URL + 'sq2-w17' },
                { id: 'w18', name: 'ダイヤモンドの斧', rarity: 'UR', atk: 100, def: 35, hp: 0, icon: ITEM_BASE_URL + 'sq2-w18' },
                { id: 'w19', name: 'ダイヤモンドの槍', rarity: 'UR', atk: 100, def: 0, hp: 35, icon: ITEM_BASE_URL + 'sq2-w19' },
                { id: 'w20', name: 'ダイヤモンドの盾', rarity: 'UR', atk: 0, def: 135, hp: 0, icon: ITEM_BASE_URL + 'sq2-w20' },
                { id: "w21", name: "ブラッククリスタルの剣", category: "Weapon", rarity: "LE", atk: 0, hp: 405, def: 0, img: "sq2-w21" },
 　　　　　　    { id: "w22", name: "ブラッククリスタルの斧", category: "Weapon", rarity: "LE", atk: 0, hp: 300, def: 105, img: "sq2-w22" },
                { id: "w23", name: "ブラッククリスタルの槍", category: "Weapon", rarity: "LE", atk: 105, hp: 300, def: 0, img: "sq2-w23" },
                { id: "w24", name: "ブラッククリスタルの盾", category: "Weapon", rarity: "LE", atk: 0, hp: 0, def: 405, img: "sq2-w24" },
　　
        　armor: [
    // --- 新しい防具データ (a1 - a12) ---
    // Standard Armor Series
               { id: "a1", name: "木の鎧", category: "Armor", rarity: "N", atk: 2, hp: 0, def: 3, img: "sq2-a1" },
    { id: "a2", name: "鉄の鎧", category: "Armor", rarity: "R", atk: 5, hp: 0, def: 10, img: "sq2-a2" },
    { id: "a3", name: "金の鎧", category: "Armor", rarity: "SR", atk: 15, hp: 0, def: 30, img: "sq2-a3" },
    { id: "a4", name: "ダイヤモンドの鎧", category: "Armor", rarity: "UR", atk: 35, hp: 0, def: 100, img: "sq2-a4" },
    { id: "a5", name: "ブラッククリスタルの鎧", category: "Armor", rarity: "LE", atk: 105, hp: 0, def: 300, img: "sq2-a5" },

    // Low-Tier/Themed Armor
    { id: "a6", name: "布の鎧", category: "Armor", rarity: "N", atk: 3, hp: 0, def: 2, img: "sq2-a6" },
    { id: "a7", name: "葉っぱの鎧", category: "Armor", rarity: "N", atk: 3, hp: 0, def: 2, img: "sq2-a7" },
    { id: "a12", name: "石の鎧", category: "Armor", rarity: "N", atk: 0, hp: 0, def: 5, img: "sq2-a12" }, // Moved N-rarity up for grouping

    // Elemental Armor Series (R-rarity)
    { id: "a8", name: "火の鎧", category: "Armor", rarity: "R", atk: 4, hp: 4, def: 7, img: "sq2-a8" },
    { id: "a9", name: "水の鎧", category: "Armor", rarity: "R", atk: 7, hp: 4, def: 4, img: "sq2-a9" },
    { id: "a10", name: "風の鎧", category: "Armor", rarity: "R", atk: 7, hp: 0, def: 8, img: "sq2-a10" },
    { id: "a11", name: "雷の鎧", category: "Armor", rarity: "R", atk: 4, hp: 7, def: 4, img: "sq2-a11" },
];

            ],
            
            pet: [
                { id: 'p1', name: 'スライム', rarity: 'N', atk: 2, def: 2, hp: 5, icon: ITEM_BASE_URL + 'PET1' },
                { id: 'p2', name: '妖精ピクシー', rarity: 'R', atk: 5, def: 5, hp: 10, icon: ITEM_BASE_URL + 'PET2' },
                { id: 'p3', name: '守護犬ケルベロス', rarity: 'SR', atk: 10, def: 15, hp: 20, icon: ITEM_BASE_URL + 'PET3' },
                { id: 'p4', name: '賢者のフクロウ', rarity: 'UR', atk: 20, def: 10, hp: 40, icon: ITEM_BASE_URL + 'PET4' },
                { id: 'p5', name: '神竜ファフニール', rarity: 'L', atk: 50, def: 30, hp: 80, icon: ITEM_BASE_URL + 'PET5' },
            ]
        };

        const MONSTERS_BY_STAGE = [
            // Stage 1
            [
                { name: '雑魚スライム', hp: 20, atk: 5, def: 0, exp: 5, itemDrop: 1, icon: MONSTER_BASE_URL + 'M-SLIME' },
                { name: 'ゴブリン', hp: 30, atk: 8, def: 2, exp: 10, itemDrop: 2, icon: MONSTER_BASE_URL + 'M-GOBLIN' },
            ],
            // Stage 2
            [
                { name: 'ウォーウルフ', hp: 50, atk: 15, def: 5, exp: 15, itemDrop: 3, icon: MONSTER_BASE_URL + 'M-WOLF' },
                { name: 'オーク', hp: 70, atk: 20, def: 8, exp: 20, itemDrop: 4, icon: MONSTER_BASE_URL + 'M-ORC' },
            ],
            // Boss for Stage 1 (Appears after 10 kills)
            { name: 'ステージ1ボス：大鬼', hp: 200, atk: 30, def: 10, exp: 100, itemDrop: 10, icon: MONSTER_BASE_URL + 'BOSS1' },
            // Boss for Stage 2
            { name: 'ステージ2ボス：リザードマンロード', hp: 400, atk: 50, def: 20, exp: 200, itemDrop: 20, icon: MONSTER_BASE_URL + 'BOSS2' },
        ];

        const INITIAL_STATE = {
            gachaTickets: 0,
            enhancementItems: 0, 
            stage: 1,
            maxHp: 100,
            currentHp: 100,
            baseAttack: 10,
            baseDefense: 5,
            killsUntilBoss: 10,
            inventory: [],
            equipment: {
                weapon1: null,
                weapon2: null,
                armor: null,
                pet1: null,
                pet2: null,
                pet3: null,
            },
            currentMonsters: [], 
            lastLoginDate: new Date().toDateString(),
            studyLogs: [],
        };

        // --- Local Storage Management ---

        function loadGameState() {
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    gameState = { ...INITIAL_STATE, ...parsedState };
                } catch (e) {
                    console.error("Failed to parse game state from localStorage. Using initial state.", e);
                    gameState = INITIAL_STATE;
                }
            } else {
                gameState = INITIAL_STATE;
            }
        }

        function saveGameState() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error("Failed to save game state to localStorage.", e);
                showToast("データ保存に失敗しました。", 'error');
            }
        }

        // --- Core Application Setup ---
        window.onload = function() {
            // 1. Load State
            loadGameState();

            // 2. Initial Setup
            setupApp();
            
            // 3. Setup Modal OK button listener
            document.getElementById('modal-ok-button').addEventListener('click', hideModal);
        };

        function setupApp() {
            // ログイン日をチェックし、HPを回復
            checkAndResetHP(); 
            // ステータスを計算
            calculateStats();
            // UIをレンダリング
            renderUI();
            
            showTab('study');
        }

        // --- State Management and Calculations ---

        function calculateStats() {
            const equipped = gameState.equipment;
            let totalAtk = gameState.baseAttack;
            let totalDef = gameState.baseDefense;
            let totalMaxHp = gameState.maxHp;

            const equipSlots = ['weapon1', 'weapon2', 'armor', 'pet1', 'pet2', 'pet3'];

            equipSlots.forEach(slot => {
                const itemId = equipped[slot];
                if (!itemId) return;

                const itemEntry = gameState.inventory.find(inv => inv.itemId === itemId);
                
                if (itemEntry && itemEntry.type && ITEMS[itemEntry.type] && Array.isArray(ITEMS[itemEntry.type])) {
                    const itemData = ITEMS[itemEntry.type].find(i => i.id === itemEntry.id);
                    if (itemData) {
                        const plus = itemEntry.plus || 0;
                        
                        // 装備の基本ステータスを加算
                        totalAtk += (itemData.atk || 0);
                        totalDef += (itemData.def || 0);
                        totalMaxHp += (itemData.hp || 0);

                        // 強化ボーナスを適用
                        // ATK/DEFは +1/強化レベル
                        totalAtk += plus;
                        totalDef += plus;
                        // HPは +2/強化レベル (武器・防具・ペット共通)
                        totalMaxHp += (plus * 2);
                    }
                }
            });

            // Update stats in gameState
            gameState.totalAttack = totalAtk;
            gameState.totalDefense = totalDef;
            gameState.totalMaxHp = totalMaxHp;

            // Update current HP to not exceed max HP
            if (gameState.currentHp > gameState.totalMaxHp) {
                gameState.currentHp = gameState.totalMaxHp;
            }
            if (gameState.currentHp < 0) {
                gameState.currentHp = 0;
            }

            // UI update
            document.getElementById('stage-display').textContent = gameState.stage;
            document.getElementById('gacha-tickets-display').textContent = gameState.gachaTickets;
        }

        function updateGameState(updates) {
            // Local state update
            Object.assign(gameState, updates);
            
            // Re-calculate stats and save state immediately
            calculateStats();
            saveGameState();
            renderUI();
        }

        function checkAndResetHP() {
            const today = new Date().toDateString();
            if (gameState.lastLoginDate !== today) {
                // maxHpを計算してから回復
                calculateStats();
                gameState.currentHp = gameState.totalMaxHp;
                gameState.lastLoginDate = today;
                updateGameState({ currentHp: gameState.currentHp, lastLoginDate: today });
                showToast("体力全回復！新しい一日が始まったよ！", 'info');
            } else if (gameState.currentHp > (gameState.totalMaxHp || INITIAL_STATE.maxHp)) {
                 // Adjust HP down if max HP reduced
                gameState.currentHp = gameState.totalMaxHp;
                updateGameState({ currentHp: gameState.currentHp });
            } else if (gameState.currentHp <= 0 && document.getElementById('tab-combat-content').style.display !== 'none') {
                showToast("戦闘不能！明日の回復を待とう。", 'error');
            }
        }

        // --- Modal/Dialog Functions ---

        function showModal(title, message) {
            if (isModalOpen) return;
            
            const modal = document.getElementById('rpg-modal');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const contentContainer = document.getElementById('modal-content-container');

            titleEl.textContent = title;
            messageEl.innerHTML = message;

            // Show modal and apply animation
            modal.classList.remove('hidden');
            contentContainer.classList.remove('scale-90');
            contentContainer.classList.add('scale-100');
            isModalOpen = true;
        }

        function hideModal() {
            const modal = document.getElementById('rpg-modal');
            const contentContainer = document.getElementById('modal-content-container');

            // Apply fade/shrink animation
            contentContainer.classList.remove('scale-100');
            contentContainer.classList.add('scale-90');

            setTimeout(() => {
                modal.classList.add('hidden');
                isModalOpen = false;
                // モーダルが閉じたら、studyタブを再レンダリングしてボタンを有効にする
                renderStudyTab();
            }, 300); // Wait for transition
        }


        // --- UI Rendering ---

        window.showTab = function(tabName) {
            ['study', 'inventory', 'combat', 'record'].forEach(name => {
                const content = document.getElementById(`tab-${name}-content`);
                const tab = document.getElementById(`tab-${name}`);
                if (content && tab) {
                    content.classList.toggle('hidden', name !== tabName);
                    tab.classList.toggle('bg-primary', name === tabName);
                    tab.classList.toggle('hover:bg-indigo-700', name === tabName);
                    tab.classList.toggle('hover:bg-rpg-border', name !== tabName);
                    tab.classList.toggle('bg-rpg-border', name !== tabName);
                    tab.classList.toggle('text-white', name === tabName);
                }
            });

            // Specific content rendering based on tab
            switch (tabName) {
                case 'study':
                    renderStudyTab();
                    break;
                case 'inventory':
                    renderInventoryTab();
                    break;
                case 'combat':
                    renderCombatTab();
                    break;
                case 'record':
                    renderRecordTab();
                    break;
            }
        };

        function renderUI() {
            calculateStats();
            const currentTabElement = document.querySelector('.tab-content:not(.hidden)');
            const currentTab = currentTabElement ? currentTabElement.id.replace('tab-', '').replace('-content', '') : 'study';
            showTab(currentTab); // Re-render current tab
        }

        // --- Helper Functions ---

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            let bgColor = 'bg-secondary';
            if (type === 'error') bgColor = 'bg-hp-red';
            if (type === 'info') bgColor = 'bg-blue-500';

            toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-xl opacity-0 transition-opacity duration-300 transform translate-y-2`;
            toast.textContent = message;
            container.appendChild(toast);

            // Fade in and move up
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 50);

            // Fade out and remove
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function getRarityClass(rarity) {
            return `rarity-${rarity.toLowerCase()} text-white font-bold px-2 py-0.5 rounded-full text-xs`;
        }

        function getItemDetails(itemId, type) {
            const itemArray = ITEMS[type];
            if (!itemArray || !Array.isArray(itemArray)) {
                return { name: '不明なアイテム', rarity: 'N', atk: 0, def: 0, hp: 0, icon: 'https://placehold.co/50x50/6b7280/f3f4f6?text=?' };
            }
            const item = itemArray.find(i => i.id === itemId);
            return item || { name: '不明なアイテム', rarity: 'N', atk: 0, def: 0, hp: 0, icon: 'https://placehold.co/50x50/6b7280/f3f4f6?text=?' };
        }

        // --- TAB 1: Study & Gacha ---

        window.stampStudy = function(type) {
            if (isModalOpen) return;
            
            const typeNames = {
                'math': '数学', 'code': 'プログラミング', 'lang': '語学', 'other': 'その他'
            };

            // Add log
            const newLog = {
                timestamp: Date.now(),
                stampType: typeNames[type],
            };
            
            const newStudyLogs = [...(gameState.studyLogs || []), newLog];

            // Update State
            updateGameState({
                gachaTickets: gameState.gachaTickets + 1,
                studyLogs: newStudyLogs,
            });
            
            // モーダルを表示し、OKを押すまで次の操作をブロック
            showModal("スタンプ完了！", `きょうもがんばったね！ (${typeNames[type]}) ガチャ券<span class="text-yellow-400 font-bold ml-1">+1</span> を獲得した！`);
            renderStudyTab();
        };

        function renderStudyTab() {
            const content = document.getElementById('tab-study-content');
            
            // ボタンの有効/無効状態を管理 (isModalOpen中は無効)
            const buttonDisabled = isModalOpen ? 'disabled bg-gray-500 cursor-not-allowed' : '';

            // Study Stamp Section
            const stampHtml = `
                <div class="mb-8 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">勉強スタンプ機能</h2>
                    <p class="mb-4 text-sm text-gray-400">勉強内容に合わせてスタンプを押すと、ガチャ券がもらえます。</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button onclick="stampStudy('math')" class="rpg-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-lg ${buttonDisabled}">
                            🔢 数学
                        </button>
                        <button onclick="stampStudy('code')" class="rpg-button bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl text-lg ${buttonDisabled}">
                            💻 プログラミング
                        </button>
                        <button onclick="stampStudy('lang')" class="rpg-button bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 rounded-xl text-lg ${buttonDisabled}">
                            🗣️ 語学
                        </button>
                        <button onclick="stampStudy('other')" class="rpg-button bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl text-lg ${buttonDisabled}">
                            ⭐ その他
                        </button>
                    </div>
                </div>
            `;

            // Gacha Section
            const canPullGacha = gameState.gachaTickets > 0 && !isModalOpen;
            const gachaHtml = `
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ガチャ機能</h2>
                    <p class="mb-4 text-sm text-gray-400">現在、ガチャ券: <span class="text-yellow-400 font-bold">${gameState.gachaTickets}</span>枚</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="pullGacha('weapon')" ${canPullGacha ? '' : 'disabled'}
                                class="rpg-button ${canPullGacha ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-500 cursor-not-allowed'} text-white font-bold py-4 rounded-xl text-xl ${buttonDisabled}">
                            ⚔️ 武器ガチャ (1枚消費)
                        </button>
                        <button onclick="pullGacha('pet')" ${canPullGacha ? '' : 'disabled'}
                                class="rpg-button ${canPullGacha ? 'bg-teal-600 hover:bg-teal-700' : 'bg-gray-500 cursor-not-allowed'} text-white font-bold py-4 rounded-xl text-xl ${buttonDisabled}">
                            🐾 ペットガチャ (1枚消費)
                        </button>
                    </div>
                    <p class="mt-4 text-xs text-gray-400">
                        確率: N(50%), R(30%), SR(15%), UR(4%), L(1%)<br>
                        同一アイテムは+1され、ステータスが強化されます。
                    </p>
                </div>
            `;
            content.innerHTML = stampHtml + gachaHtml;
        }

        window.pullGacha = function(type) {
            if (isModalOpen) return;
            if (gameState.gachaTickets <= 0) {
                showToast("ガチャ券が足りません！", 'error');
                return;
            }

            // 1. Determine Rarity
            const rand = Math.random() * 100;
            let cumulativeWeight = 0;
            let selectedRarity = null;
            const rarities = Object.keys(rarityWeights).reverse();

            for (const rarity of rarities) {
                cumulativeWeight += rarityWeights[rarity];
                if (rand < cumulativeWeight) {
                    selectedRarity = rarity;
                    break;
                }
            }
            if (!selectedRarity) selectedRarity = 'N';

            // 2. Select Item of that Rarity
            const availableItems = ITEMS[type].filter(item => item.rarity === selectedRarity);
            const selectedItemData = availableItems[Math.floor(Math.random() * availableItems.length)];
            
            // 3. Check Inventory for Duplicates
            const existingItemIndex = gameState.inventory.findIndex(inv => inv.id === selectedItemData.id);

            let message = "";

            if (existingItemIndex !== -1) {
                // Duplicate: Increase plus value
                gameState.inventory[existingItemIndex].plus = (gameState.inventory[existingItemIndex].plus || 0) + 1;
                message = `
                    <div class="flex items-center justify-center mb-3">
                        <img src="${selectedItemData.icon}" alt="アイテム画像" class="item-icon mr-4">
                        <span class="text-yellow-400">${selectedItemData.name}</span>を入手！
                    </div>
                    <span class="text-orange-400">強化値が +${gameState.inventory[existingItemIndex].plus} になりました！</span>
                `;
            } else {
                // New Item: Add to inventory
                const newItem = {
                    id: selectedItemData.id,
                    type: type,
                    plus: 0,
                    itemId: crypto.randomUUID(), // Unique ID for equipping
                };
                gameState.inventory.push(newItem);
                message = `
                    <div class="flex items-center justify-center mb-3">
                        <img src="${selectedItemData.icon}" alt="アイテム画像" class="item-icon mr-4">
                        <span class="${getRarityClass(selectedRarity)} text-base mr-2">${selectedRarity}</span>
                        <span class="text-yellow-400 text-lg font-bold">${selectedItemData.name}</span>
                    </div>
                    を新しく入手した！
                `;
            }

            // 4. Update Game State
            updateGameState({
                gachaTickets: gameState.gachaTickets - 1,
                inventory: gameState.inventory
            });
            
            // Show modal instead of toast
            showModal("ガチャ結果発表！", message);
            renderStudyTab();
        };

        // --- TAB 2: Inventory & Equipment ---

        function renderInventoryTab() {
            calculateStats();
            const content = document.getElementById('tab-inventory-content');

            // --- A. Stat Display ---
            const statHtml = `
                <div class="mb-6 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">主人公ステータス</h2>
                    <div class="flex flex-wrap gap-4 text-lg">
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-hp-red">HP:</span> ${gameState.currentHp} / ${gameState.totalMaxHp}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-red-400">ATK (攻撃力):</span> ${gameState.totalAttack}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-blue-400">DEF (防御力):</span> ${gameState.totalDefense}</div>
                        <div class="bg-gray-600 p-2 rounded-lg"><span class="font-bold text-yellow-400">強化アイテム:</span> ${gameState.enhancementItems}個</div>
                    </div>
                </div>
            `;

            // --- B. Equipment Slots ---
            const slots = {
                weapon1: { label: '武器1', defaultIcon: '⚔️' },
                weapon2: { label: '武器2', defaultIcon: '🗡️' },
                armor: { label: '防具', defaultIcon: '🛡️' },
                pet1: { label: 'ペット1', defaultIcon: '🐾' },
                pet2: { label: 'ペット2', defaultIcon: '🐾' },
                pet3: { label: 'ペット3', defaultIcon: '🐾' },
            };

            const equipHtml = `
                <div class="mb-8 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">装備 (2武器 / 1防具 / 3ペット)</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                        ${Object.entries(slots).map(([slotKey, slotInfo]) => {
                            const equippedItemId = gameState.equipment[slotKey];
                            const equippedItemEntry = gameState.inventory.find(inv => inv.itemId === equippedItemId);
                            
                            let itemDisplay = '<span class="text-gray-400">未装備</span>';
                            let itemClass = 'bg-gray-700';
                            let itemIconHtml = `<span class="text-xl mr-2">${slotInfo.defaultIcon}</span>`;

                            if (equippedItemEntry) {
                                const itemData = getItemDetails(equippedItemEntry.id, equippedItemEntry.type);
                                itemDisplay = `${itemData.name} +${equippedItemEntry.plus}`;
                                itemClass = `bg-primary`;
                                // 画像表示: 装備アイテムの画像を表示
                                itemIconHtml = `<img src="${itemData.icon}" alt="${itemData.name}" class="item-icon w-6 h-6 mr-2">`;
                            }

                            return `
                                <div class="p-3 rounded-lg ${itemClass} shadow-md flex justify-start items-center text-sm md:text-base">
                                    ${itemIconHtml}
                                    <div class="flex flex-col">
                                        <span class="font-bold text-xs">${slotInfo.label}:</span>
                                        <span class="truncate">${itemDisplay}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // --- C. Inventory List ---
            const inventoryHtml = `
                <div>
                    <h2 class="text-2xl font-semibold mb-4 text-primary">アイテム一覧 (${gameState.inventory.length}種類)</h2>
                    <div class="space-y-3">
                        ${gameState.inventory.length === 0 ? '<p class="text-center text-gray-400">ガチャを引いてアイテムを入手しよう！</p>' : ''}
                        ${gameState.inventory.map(itemEntry => {
                            const itemData = getItemDetails(itemEntry.id, itemEntry.type);
                            const isEquipped = Object.values(gameState.equipment).includes(itemEntry.itemId);
                            // HPの基本値が0でも、ペット以外は表示しない (見た目をシンプルにするため)
                            const statText = itemEntry.type === 'pet'
                                ? `HP+${itemData.hp}, ATK+${itemData.atk}, DEF+${itemData.def}`
                                : `HP+${itemData.hp}, ATK+${itemData.atk}, DEF+${itemData.def}`;
                            const typeLabel = itemEntry.type === 'weapon' ? '武器' : (itemEntry.type === 'armor' ? '防具' : 'ペット');
                            const canEnhance = gameState.enhancementItems > 0 && itemEntry.plus < 100;

                            return `
                                <div class="bg-rpg-border p-3 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center shadow-lg">
                                    <div class="flex items-center mb-2 md:mb-0 w-full md:w-3/5">
                                        <!-- 画像表示: インベントリアイテムの画像 -->
                                        <img src="${itemData.icon}" alt="${itemData.name}" class="item-icon mr-2">
                                        <span class="${getRarityClass(itemData.rarity)} mr-2">${itemData.rarity}</span>
                                        <span class="font-extrabold text-lg mr-2">${itemData.name}</span>
                                        <span class="text-yellow-400 font-bold text-xl">+${itemEntry.plus}</span>
                                        <span class="ml-4 text-xs bg-gray-600 px-2 py-0.5 rounded">${typeLabel}</span>
                                        ${isEquipped ? '<span class="ml-2 text-sm bg-green-500 px-2 py-0.5 rounded text-white font-bold">装備中</span>' : ''}
                                    </div>
                                    <div class="flex flex-wrap gap-2 w-full md:w-2/5 justify-start md:justify-end">
                                        <span class="text-sm text-gray-300 mr-4">${statText}</span>
                                        <button onclick="enhanceItem('${itemEntry.itemId}')" ${canEnhance ? '' : 'disabled'}
                                            class="rpg-button ${canEnhance ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-500 cursor-not-allowed'} text-white text-xs px-2 py-1 rounded">
                                            強化 (+1)
                                        </button>
                                        <button onclick="toggleEquip('${itemEntry.itemId}')"
                                            class="rpg-button ${isEquipped ? 'bg-red-500 hover:bg-red-600' : 'bg-secondary hover:bg-emerald-600'} text-white text-xs px-2 py-1 rounded">
                                            ${isEquipped ? '解除' : '装備'}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            content.innerHTML = statHtml + equipHtml + inventoryHtml;
        }

        window.enhanceItem = function(itemId) {
            if (gameState.enhancementItems <= 0) {
                showToast("強化アイテムがありません。", 'error');
                return;
            }

            const itemIndex = gameState.inventory.findIndex(inv => inv.itemId === itemId);
            if (itemIndex === -1) return;

            gameState.inventory[itemIndex].plus = (gameState.inventory[itemIndex].plus || 0) + 1;
            
            updateGameState({
                inventory: gameState.inventory,
                enhancementItems: gameState.enhancementItems - 1,
            });

            const itemData = getItemDetails(gameState.inventory[itemIndex].id, gameState.inventory[itemIndex].type);
            showToast(`${itemData.name}が+${gameState.inventory[itemIndex].plus}に強化されました！`, 'success');
        };

        window.toggleEquip = function(itemId) {
            const itemEntry = gameState.inventory.find(inv => inv.itemId === itemId);
            if (!itemEntry) return;
            const type = itemEntry.type;
            
            let updates = {};
            let action = 'equip';

            let slotToUnequip = null;
            let slotToEquip = null;

            // Find where it's equipped
            for (const [key, value] of Object.entries(gameState.equipment)) {
                if (value === itemId) {
                    slotToUnequip = key;
                    action = 'unequip';
                    break;
                }
            }

            if (action === 'unequip') {
                // Unequip action
                updates.equipment = { ...gameState.equipment, [slotToUnequip]: null };
            } else {
                // Equip action
                const slotsForType = {
                    weapon: ['weapon1', 'weapon2'],
                    armor: ['armor'],
                    pet: ['pet1', 'pet2', 'pet3']
                }[type];

                // Find the first empty slot or the first occupied slot of the same type to overwrite
                slotToEquip = slotsForType.find(slot => !gameState.equipment[slot]);
                if (!slotToEquip) {
                    // If all slots of this type are full, overwrite the first one (simple logic: overwrite slot 1)
                    slotToEquip = slotsForType[0];
                }
                updates.equipment = { ...gameState.equipment, [slotToEquip]: itemId };
            }

            updateGameState(updates);
            showToast(action === 'equip' ? `${itemEntry.name}を装備しました。` : `${itemEntry.name}の装備を解除しました。`, 'info');
        };

        // --- TAB 3: Combat ---
        
        // HPバーに揺れアニメーションを適用・解除する関数
        function applyShake(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('shake');
                // DOMの再描画を強制するためのトリック
                void element.offsetWidth;
                element.classList.add('shake');
                setTimeout(() => {
                    element.classList.remove('shake');
                }, 500); // アニメーション時間に合わせて解除
            }
        }


        function renderCombatTab() {
            calculateStats();
            const content = document.getElementById('tab-combat-content');
            
            if (gameState.currentHp <= 0) {
                content.innerHTML = `
                    <div class="text-center p-8 bg-hp-red rounded-xl shadow-2xl">
                        <h2 class="text-3xl font-bold mb-4">💀 戦闘不能 💀</h2>
                        <p class="text-xl">きみのHPは0だ！今日はもう休もう。</p>
                        <p class="mt-4">体力は日付が変わると全回復します。</p>
                    </div>
                `;
                return;
            }

            // If no monsters, initialize them
            if (gameState.currentMonsters.length === 0) {
                initializeMonsters();
            }

            // Stat Display (detailed)
            const hpPercent = Math.max(0, (gameState.currentHp / gameState.totalMaxHp) * 100);
            const statHtml = `
                <div class="mb-6 border-b border-rpg-border pb-4">
                    <h2 class="text-2xl font-semibold mb-3 text-primary">主人公ステータス</h2>
                    <div id="player-hp-bar" class="bg-gray-600 p-3 rounded-lg shadow-inner">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold">主人公 HP:</span>
                            <span class="font-mono text-hp-red">${gameState.currentHp} / ${gameState.totalMaxHp}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="bg-hp-red h-3 rounded-full" style="width: ${hpPercent}%"></div>
                        </div>
                        <div class="flex justify-around mt-2 text-sm">
                            <p>ATK: <span class="text-red-400 font-bold">${gameState.totalAttack}</span></p>
                            <p>DEF: <span class="text-blue-400 font-bold">${gameState.totalDefense}</span></p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-400 mt-2">次のボスまであと ${gameState.killsUntilBoss} 匹</p>
                </div>
            `;

            // Monster Display
            const monsterHtml = `
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-4 text-primary">ステージ ${gameState.stage} の敵</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${gameState.currentMonsters.map((m, index) => {
                            const hpPercent = Math.max(0, (m.hp / m.maxHp) * 100);
                            return `
                                <div id="monster-card-${index}" class="bg-rpg-border p-3 rounded-lg shadow-lg ${m.hp <= 0 ? 'opacity-50' : ''}">
                                    <!-- 画像表示: モンスターの画像 -->
                                    <img src="${m.icon}" alt="${m.name}" class="monster-icon mb-1">
                                    <p class="font-bold text-lg text-center">${m.name} ${m.hp <= 0 ? '(撃破)' : ''}</p>
                                    <div id="monster-hp-bar-${index}">
                                        <p class="text-sm">HP: <span class="font-mono">${Math.max(0, m.hp)} / ${m.maxHp}</span></p>
                                        <div class="w-full bg-gray-700 rounded-full h-2 my-1">
                                            <div class="bg-yellow-400 h-2 rounded-full" style="width: ${hpPercent}%"></div>
                                        </div>
                                    </div>
                                    <p class="text-xs">ATK:${m.atk} / DEF:${m.def}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;

            // Action Button
            const actionHtml = `
                <div class="text-center">
                    <button onclick="playerAttack()" class="rpg-button bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-8 rounded-xl text-xl">
                        🔥 攻撃する
                    </button>
                    <div id="combat-log" class="mt-4 p-3 bg-gray-700 rounded-lg max-h-40 overflow-y-auto text-left text-sm space-y-1">
                        <p class="text-gray-400">戦闘ログ</p>
                    </div>
                </div>
            `;

            content.innerHTML = statHtml + monsterHtml + actionHtml;
        }

        function initializeMonsters() {
            const monsters = [];
            const stageIndex = gameState.stage - 1;
            const stageMonsters = MONSTERS_BY_STAGE[stageIndex];
            
            if (gameState.killsUntilBoss <= 0) {
                // Boss
                const bossDataIndex = gameState.stage === 1 ? MONSTERS_BY_STAGE.length - 2 : MONSTERS_BY_STAGE.length - 1;
                const bossData = MONSTERS_BY_STAGE[bossDataIndex];
                monsters.push({ ...bossData, hp: bossData.hp, maxHp: bossData.hp, icon: bossData.icon });
            } else {
                // 3 regular monsters
                for (let i = 0; i < 3; i++) {
                    const monsterData = stageMonsters[Math.floor(Math.random() * stageMonsters.length)];
                    monsters.push({ ...monsterData, hp: monsterData.hp, maxHp: monsterData.hp, icon: monsterData.icon });
                }
            }

            gameState.currentMonsters = monsters;
            updateGameState({ currentMonsters: monsters });
        }

        function appendLog(message, isPlayer = false) {
            const logElement = document.getElementById('combat-log');
            if (!logElement) return;

            const entry = document.createElement('p');
            entry.className = isPlayer ? 'text-green-300' : 'text-yellow-300';
            entry.textContent = message;

            logElement.prepend(entry);
            // Keep max 10 entries
            while (logElement.children.length > 10) {
                logElement.removeChild(logElement.lastChild);
            }
        }

        window.playerAttack = function() {
            if (gameState.currentHp <= 0) {
                showToast("戦闘不能です。", 'error');
                return;
            }

            // 1. Player Attack Phase (Target the first alive monster)
            const targetIndex = gameState.currentMonsters.findIndex(m => m.hp > 0);
            if (targetIndex === -1) {
                checkStageCompletion();
                return;
            }

            const targetMonster = gameState.currentMonsters[targetIndex];
            const playerDmg = Math.max(1, gameState.totalAttack - targetMonster.def);
            targetMonster.hp -= playerDmg;

            appendLog(`主人公の攻撃！ ${targetMonster.name}に ${playerDmg} のダメージ！`, true);
            applyShake(`monster-hp-bar-${targetIndex}`); // モンスターHPバーを揺らす
            
            let monsterDefeated = false;
            // Check if monster is defeated
            if (targetMonster.hp <= 0) {
                targetMonster.hp = 0;
                appendLog(`🎉 ${targetMonster.name} を撃破した！`, true);
                monsterDefeated = true;
                
                // Drop items and check boss progress
                gameState.enhancementItems += targetMonster.itemDrop;
                appendLog(`+${targetMonster.itemDrop} 強化アイテムを入手！`, true);

                if (gameState.killsUntilBoss > 0) {
                    gameState.killsUntilBoss--;
                }
            }
            
            // Check for immediate completion
            if (gameState.currentMonsters.filter(m => m.hp > 0).length === 0) {
                updateGameState({
                    currentMonsters: gameState.currentMonsters,
                    enhancementItems: gameState.enhancementItems,
                    killsUntilBoss: gameState.killsUntilBoss,
                });
                checkStageCompletion();
                return; 
            }

            // 2. Monster Attack Phase (All alive monsters attack sequentially)
            let playerFainted = false;
            for (let i = 0; i < gameState.currentMonsters.length; i++) {
                const monster = gameState.currentMonsters[i];
                if (monster.hp > 0) {
                    const monsterDmg = Math.max(1, monster.atk - gameState.totalDefense);
                    gameState.currentHp -= monsterDmg;
                    
                    if (gameState.currentHp > 0) {
                        applyShake('player-hp-bar'); // 主人公HPバーを揺らす
                    }

                    appendLog(`${monster.name} の攻撃！ ${monsterDmg} のダメージを受けた！`);

                    if (gameState.currentHp <= 0) {
                        gameState.currentHp = 0;
                        appendLog(`💀 主人公は戦闘不能になった...`, false);
                        playerFainted = true;
                        break;
                    }
                }
            }

            // 3. Update State and UI
            updateGameState({
                currentHp: gameState.currentHp,
                currentMonsters: gameState.currentMonsters,
                enhancementItems: gameState.enhancementItems,
                killsUntilBoss: gameState.killsUntilBoss,
            });

            if (!playerFainted && monsterDefeated) {
                checkStageCompletion(); 
            }
        };

        function checkStageCompletion() {
            const allMonstersDefeated = gameState.currentMonsters.filter(m => m.hp > 0).length === 0;
            
            if (!allMonstersDefeated) return;

            const isBoss = gameState.currentMonsters.some(m => m.name.includes('ボス'));

            if (isBoss) {
                // Boss defeated: Advance Stage
                const nextStage = gameState.stage + 1;
                if (nextStage <= MONSTERS_BY_STAGE.length - 2) { 
                    showToast(`🏆 ステージ${gameState.stage}をクリア！次のステージへ！`, 'info');
                    updateGameState({
                        stage: nextStage,
                        killsUntilBoss: 10,
                        currentMonsters: [],
                    });
                } else {
                    showToast("🎉 全てのステージをクリア！君は最強だ！", 'info');
                    updateGameState({ currentMonsters: [] });
                }
            } else if (gameState.killsUntilBoss <= 0) {
                // Regular monsters defeated, and boss threshold reached: Spawn Boss
                showToast("🚨 強力な魔力の気配...ステージボスが出現した！", 'error');
                updateGameState({ currentMonsters: [] });
            } else {
                // Regular monsters defeated, reset 3 new ones
                showToast("敵を全て倒した！新たな敵が現れた。", 'success');
                updateGameState({ currentMonsters: [] });
            }
            
            renderCombatTab();
        }

        // --- TAB 4: Record ---

        function renderRecordTab() {
            const content = document.getElementById('tab-record-content');
            const logs = [...(gameState.studyLogs || [])].sort((a, b) => b.timestamp - a.timestamp);

            const recordHtml = `
                <h2 class="text-2xl font-semibold mb-4 text-primary">勉強記録ページ</h2>
                <div class="space-y-3 max-h-96 overflow-y-auto p-2">
                    ${logs.length === 0 
                        ? '<p class="text-center text-gray-400">まだ勉強記録がありません。スタンプを押して記録しましょう！</p>' 
                        : logs.map(log => {
                            const date = new Date(log.timestamp).toLocaleString('ja-JP', { dateStyle: 'medium', timeStyle: 'short' });
                            const bgColor = {
                                '数学': 'bg-blue-600', 'プログラミング': 'bg-green-600', '語学': 'bg-yellow-600', 'その他': 'bg-purple-600'
                            }[log.stampType] || 'bg-gray-600';

                            return `
                                <div class="p-3 rounded-lg ${bgColor} bg-opacity-70 shadow-md flex justify-between items-center text-white">
                                    <span class="font-bold">${log.stampType} スタンプ</span>
                                    <span class="text-sm">${date}</span>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
            content.innerHTML = recordHtml;
        }

    </script>
</body>
</html>
